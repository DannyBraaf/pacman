# This is a basic workflow to help you get started with Actions

name: test

# Controls when the workflow will run
on:



  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  Run-Testim:
      runs-on: ubuntu-latest
      steps:
      - name: run testim testcases
        run: npm i -g @testim/testim-cli && testim --token "okolUMBR7BVLxTIZr7CDSdFphCBB3CLPYSdwhCdTbBZPSmai66" --project "VvXEosqxNXwuiV8e0RMS" --grid "Testim-Grid" --report-file "report.xml"
      - name: parse xml 
        id: getxml
        uses: QwerMike/xpath-action@v1
        with:
          filename: 'report.xml'
          expression: '/testsuites/testsuite[1]/@failure'
      - name: check result
        run: |
           echo ${{ steps.getxml.outputs.result}}
           export timestamp=$(date +%s%3N)
           if [[ '${{ steps.getxml.outputs.result}}' == ' failure="0"' ]]
           then
           export result = 100
           else
           export result = 0
           fi
                      
           get_evaluation_body()
           {
             cat <<EOF
           {
             "type": "SERVICE",
             "series": [
               {
                 "timeseriesId": "custom:Demoserviceappstest",
                 "dataPoints" : [[ $timestamp, $result ]]
               }
             ]
           }
           EOF
           }
                  
           curl -X POST "https://ozw11698.live.dynatrace.com/api/v1/entity/infrastructure/custom/custom:Demoserviceappstest" \
           -H "accept: application/json" \
           -H "Authorization: Api-Token ${{ secrets.DT_API_TOKEN }}" \
           -H "Content-Type: application/json" \
           -d "$(get_evaluation_body)"
           
           
           

